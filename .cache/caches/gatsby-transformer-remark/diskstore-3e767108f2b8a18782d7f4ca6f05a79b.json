{"expireTime":9007200818315814000,"key":"transformer-remark-markdown-ast-0b3f0f9759459d302660a86a7831ef3c-gatsby-remark-katexgatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"paragraph","children":[{"type":"text","value":"这里会记录阅读6.828课程lecture note的我的个人笔记。可能会中英混杂，不是很适合外人阅读，也请见谅。","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":58,"offset":58},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":58,"offset":58},"indent":[]}},{"type":"heading","depth":2,"children":[{"type":"text","value":"Lecture 8: Interrupts, System calls, and Exceptions","position":{"start":{"line":4,"column":4,"offset":63},"end":{"line":4,"column":55,"offset":114},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":60},"end":{"line":4,"column":55,"offset":114},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这次的主题就是说当硬件want attention的时候，kernel该如何进行中断。发生这件事主要有3种情况：","position":{"start":{"line":6,"column":1,"offset":116},"end":{"line":6,"column":57,"offset":172},"indent":[]}}],"position":{"start":{"line":6,"column":1,"offset":116},"end":{"line":6,"column":57,"offset":172},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Exceptions (page fault, divide by zero)","position":{"start":{"line":8,"column":3,"offset":176},"end":{"line":8,"column":42,"offset":215},"indent":[]}}],"position":{"start":{"line":8,"column":3,"offset":176},"end":{"line":8,"column":42,"offset":215},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":174},"end":{"line":8,"column":42,"offset":215},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"System calls (","position":{"start":{"line":9,"column":3,"offset":218},"end":{"line":9,"column":17,"offset":232},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">INT</code>","position":{"start":{"line":9,"column":17,"offset":232},"end":{"line":9,"column":22,"offset":237},"indent":[]}},{"type":"text","value":", intended exception)","position":{"start":{"line":9,"column":22,"offset":237},"end":{"line":9,"column":43,"offset":258},"indent":[]}}],"position":{"start":{"line":9,"column":3,"offset":218},"end":{"line":9,"column":43,"offset":258},"indent":[]}}],"position":{"start":{"line":9,"column":1,"offset":216},"end":{"line":9,"column":43,"offset":258},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Interrupts (devices want attention)","position":{"start":{"line":10,"column":3,"offset":261},"end":{"line":10,"column":38,"offset":296},"indent":[]}}],"position":{"start":{"line":10,"column":3,"offset":261},"end":{"line":10,"column":38,"offset":296},"indent":[]}}],"position":{"start":{"line":10,"column":1,"offset":259},"end":{"line":10,"column":38,"offset":296},"indent":[]}}],"position":{"start":{"line":8,"column":1,"offset":174},"end":{"line":10,"column":38,"offset":296},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"注意在术语上","position":{"start":{"line":12,"column":1,"offset":298},"end":{"line":12,"column":7,"offset":304},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap</code>","position":{"start":{"line":12,"column":7,"offset":304},"end":{"line":12,"column":13,"offset":310},"indent":[]}},{"type":"text","value":"是被当前进程引发的，如system call，而interrupt是由外界device触发的。","position":{"start":{"line":12,"column":13,"offset":310},"end":{"line":12,"column":60,"offset":357},"indent":[]}}],"position":{"start":{"line":12,"column":1,"offset":298},"end":{"line":12,"column":60,"offset":357},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"device interrupt都来自哪里呢？","position":{"start":{"line":14,"column":1,"offset":359},"end":{"line":14,"column":24,"offset":382},"indent":[]}}],"position":{"start":{"line":14,"column":1,"offset":359},"end":{"line":14,"column":24,"offset":382},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"CPUs, ","position":{"start":{"line":16,"column":3,"offset":386},"end":{"line":16,"column":9,"offset":392},"indent":[]}}],"position":{"start":{"line":16,"column":3,"offset":386},"end":{"line":16,"column":9,"offset":392},"indent":[]}}],"position":{"start":{"line":16,"column":1,"offset":384},"end":{"line":16,"column":9,"offset":392},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"LAPICs (Local Advaned Programmable Interrupt Controller)，一个负责接受/发送中断的芯片，集成在CPU内部。","position":{"start":{"line":17,"column":3,"offset":395},"end":{"line":17,"column":84,"offset":476},"indent":[]}}],"position":{"start":{"line":17,"column":3,"offset":395},"end":{"line":17,"column":84,"offset":476},"indent":[]}}],"position":{"start":{"line":17,"column":1,"offset":393},"end":{"line":17,"column":84,"offset":476},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"IOAPIC (I/O Advanced Programmable Interrupt Controller)，通常位于南桥，负责外部IO设备发来的中断。","position":{"start":{"line":18,"column":3,"offset":479},"end":{"line":18,"column":80,"offset":556},"indent":[]}}],"position":{"start":{"line":18,"column":3,"offset":479},"end":{"line":18,"column":80,"offset":556},"indent":[]}}],"position":{"start":{"line":18,"column":1,"offset":477},"end":{"line":18,"column":80,"offset":556},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"devices","position":{"start":{"line":19,"column":3,"offset":559},"end":{"line":19,"column":10,"offset":566},"indent":[]}}],"position":{"start":{"line":19,"column":3,"offset":559},"end":{"line":19,"column":10,"offset":566},"indent":[]}}],"position":{"start":{"line":19,"column":1,"offset":557},"end":{"line":19,"column":10,"offset":566},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"data bus","position":{"start":{"line":20,"column":3,"offset":569},"end":{"line":20,"column":11,"offset":577},"indent":[]}}],"position":{"start":{"line":20,"column":3,"offset":569},"end":{"line":20,"column":11,"offset":577},"indent":[]}}],"position":{"start":{"line":20,"column":1,"offset":567},"end":{"line":20,"column":11,"offset":577},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"interrupt bus","position":{"start":{"line":21,"column":3,"offset":580},"end":{"line":21,"column":16,"offset":593},"indent":[]}}],"position":{"start":{"line":21,"column":3,"offset":580},"end":{"line":21,"column":16,"offset":593},"indent":[]}}],"position":{"start":{"line":21,"column":1,"offset":578},"end":{"line":21,"column":16,"offset":593},"indent":[]}}],"position":{"start":{"line":16,"column":1,"offset":384},"end":{"line":21,"column":16,"offset":593},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"中断会告诉kernel，某个设备want attention。kernel中的驱动来负责告诉设备之后该如何do things。","position":{"start":{"line":23,"column":1,"offset":595},"end":{"line":23,"column":64,"offset":658},"indent":[]}}],"position":{"start":{"line":23,"column":1,"offset":595},"end":{"line":23,"column":64,"offset":658},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"很多时候interrupt handler会直接调用相关的驱动。","position":{"start":{"line":25,"column":1,"offset":660},"end":{"line":25,"column":33,"offset":692},"indent":[]}}],"position":{"start":{"line":25,"column":1,"offset":660},"end":{"line":25,"column":33,"offset":692},"indent":[]}},{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">trap()</code>","position":{"start":{"line":27,"column":1,"offset":694},"end":{"line":27,"column":9,"offset":702},"indent":[]}},{"type":"text","value":"函数是如何知道哪个设备出发了中断？","position":{"start":{"line":27,"column":9,"offset":702},"end":{"line":27,"column":26,"offset":719},"indent":[]}}],"position":{"start":{"line":27,"column":1,"offset":694},"end":{"line":27,"column":26,"offset":719},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"kernel设置LAPIC/IOAPIC ，把某个类型的中断设置为对应的vector number","position":{"start":{"line":29,"column":3,"offset":723},"end":{"line":29,"column":52,"offset":772},"indent":[]}}],"position":{"start":{"line":29,"column":3,"offset":723},"end":{"line":29,"column":52,"offset":772},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"page fault也有vectors","position":{"start":{"line":30,"column":5,"offset":777},"end":{"line":30,"column":24,"offset":796},"indent":[]}}],"position":{"start":{"line":30,"column":5,"offset":777},"end":{"line":30,"column":24,"offset":796},"indent":[]}}],"position":{"start":{"line":30,"column":3,"offset":775},"end":{"line":30,"column":24,"offset":796},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"LAPIC/IOAPIC是PC的常规硬件，其中每个cpu有一个LAPIC","position":{"start":{"line":31,"column":5,"offset":801},"end":{"line":31,"column":41,"offset":837},"indent":[]}}],"position":{"start":{"line":31,"column":5,"offset":801},"end":{"line":31,"column":41,"offset":837},"indent":[]}}],"position":{"start":{"line":31,"column":3,"offset":799},"end":{"line":31,"column":41,"offset":837},"indent":[]}}],"position":{"start":{"line":30,"column":3,"offset":775},"end":{"line":31,"column":41,"offset":837},"indent":[3]}}],"position":{"start":{"line":29,"column":1,"offset":721},"end":{"line":31,"column":41,"offset":837},"indent":[1,1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"IDT (interrupt descriptor table)用vector number来联系一个instruction address","position":{"start":{"line":32,"column":3,"offset":840},"end":{"line":32,"column":73,"offset":910},"indent":[]}}],"position":{"start":{"line":32,"column":3,"offset":840},"end":{"line":32,"column":73,"offset":910},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"这个table的内容是怎么设置的可以看下面的","position":{"start":{"line":33,"column":5,"offset":915},"end":{"line":33,"column":27,"offset":937},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">SETGATE</code>","position":{"start":{"line":33,"column":27,"offset":937},"end":{"line":33,"column":36,"offset":946},"indent":[]}},{"type":"text","value":"函数。","position":{"start":{"line":33,"column":36,"offset":946},"end":{"line":33,"column":39,"offset":949},"indent":[]}}],"position":{"start":{"line":33,"column":5,"offset":915},"end":{"line":33,"column":39,"offset":949},"indent":[]}}],"position":{"start":{"line":33,"column":3,"offset":913},"end":{"line":33,"column":39,"offset":949},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"IDT的格式是由Intel定义的，由kernel设置的","position":{"start":{"line":34,"column":5,"offset":954},"end":{"line":34,"column":32,"offset":981},"indent":[]}}],"position":{"start":{"line":34,"column":5,"offset":954},"end":{"line":34,"column":32,"offset":981},"indent":[]}}],"position":{"start":{"line":34,"column":3,"offset":952},"end":{"line":34,"column":32,"offset":981},"indent":[]}}],"position":{"start":{"line":33,"column":3,"offset":913},"end":{"line":34,"column":32,"offset":981},"indent":[3]}}],"position":{"start":{"line":32,"column":1,"offset":838},"end":{"line":34,"column":32,"offset":981},"indent":[1,1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"每个vector都会跳到","position":{"start":{"line":35,"column":3,"offset":984},"end":{"line":35,"column":15,"offset":996},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">alltraps</code>","position":{"start":{"line":35,"column":15,"offset":996},"end":{"line":35,"column":25,"offset":1006},"indent":[]}}],"position":{"start":{"line":35,"column":3,"offset":984},"end":{"line":35,"column":25,"offset":1006},"indent":[]}}],"position":{"start":{"line":35,"column":1,"offset":982},"end":{"line":35,"column":25,"offset":1006},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"CPU会通过IDT发送各种trap，其中lower 32 IDT entries有特殊的含义。","position":{"start":{"line":36,"column":3,"offset":1009},"end":{"line":36,"column":50,"offset":1056},"indent":[]}}],"position":{"start":{"line":36,"column":3,"offset":1009},"end":{"line":36,"column":50,"offset":1056},"indent":[]}}],"position":{"start":{"line":36,"column":1,"offset":1007},"end":{"line":36,"column":50,"offset":1056},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"在xv6中，system call(IRQ)被设置为","position":{"start":{"line":37,"column":3,"offset":1059},"end":{"line":37,"column":29,"offset":1085},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">0x40</code>","position":{"start":{"line":37,"column":29,"offset":1085},"end":{"line":37,"column":35,"offset":1091},"indent":[]}},{"type":"text","value":".","position":{"start":{"line":37,"column":35,"offset":1091},"end":{"line":37,"column":36,"offset":1092},"indent":[]}}],"position":{"start":{"line":37,"column":3,"offset":1059},"end":{"line":37,"column":36,"offset":1092},"indent":[]}}],"position":{"start":{"line":37,"column":1,"offset":1057},"end":{"line":37,"column":36,"offset":1092},"indent":[]}}],"position":{"start":{"line":29,"column":1,"offset":721},"end":{"line":37,"column":36,"offset":1092},"indent":[1,1,1,1,1,1,1,1]}},{"type":"html","lang":null,"meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">diagram:\n  IRQ or trap, IDT table, vectors, alltraps\n  IDT:\n    0: divide by zero\n    13: general protection\n    14: page fault\n    32-255: device IRQs\n    32: timer\n    33: keyboard\n    46: IDE\n    64: INT</code></pre></div>","position":{"start":{"line":39,"column":1,"offset":1094},"end":{"line":51,"column":4,"offset":1308},"indent":[1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"How xv6 sets up the iterrupt vector machinery","position":{"start":{"line":53,"column":5,"offset":1314},"end":{"line":53,"column":50,"offset":1359},"indent":[]}}],"position":{"start":{"line":53,"column":1,"offset":1310},"end":{"line":53,"column":50,"offset":1359},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"那么xv6中interrupt vector机制是如何被设置的呢？","position":{"start":{"line":55,"column":1,"offset":1361},"end":{"line":55,"column":34,"offset":1394},"indent":[]}}],"position":{"start":{"line":55,"column":1,"offset":1361},"end":{"line":55,"column":34,"offset":1394},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"首先是在","position":{"start":{"line":57,"column":1,"offset":1396},"end":{"line":57,"column":5,"offset":1400},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">main.c</code>","position":{"start":{"line":57,"column":5,"offset":1400},"end":{"line":57,"column":13,"offset":1408},"indent":[]}},{"type":"text","value":"中前后运行了","position":{"start":{"line":57,"column":13,"offset":1408},"end":{"line":57,"column":19,"offset":1414},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">lapicinit()</code>","position":{"start":{"line":57,"column":19,"offset":1414},"end":{"line":57,"column":32,"offset":1427},"indent":[]}},{"type":"text","value":"、","position":{"start":{"line":57,"column":32,"offset":1427},"end":{"line":57,"column":33,"offset":1428},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">ioapicinit()</code>","position":{"start":{"line":57,"column":33,"offset":1428},"end":{"line":57,"column":47,"offset":1442},"indent":[]}},{"type":"text","value":"与","position":{"start":{"line":57,"column":47,"offset":1442},"end":{"line":57,"column":48,"offset":1443},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">tvinit()</code>","position":{"start":{"line":57,"column":48,"offset":1443},"end":{"line":57,"column":58,"offset":1453},"indent":[]}},{"type":"text","value":"。","position":{"start":{"line":57,"column":58,"offset":1453},"end":{"line":57,"column":59,"offset":1454},"indent":[]}}],"position":{"start":{"line":57,"column":1,"offset":1396},"end":{"line":57,"column":59,"offset":1454},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"在","position":{"start":{"line":59,"column":1,"offset":1456},"end":{"line":59,"column":2,"offset":1457},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">lapicinit()</code>","position":{"start":{"line":59,"column":2,"offset":1457},"end":{"line":59,"column":15,"offset":1470},"indent":[]}},{"type":"text","value":"中告诉LAPIC这个硬件把例如timer设置为对应的vector number(32)。","position":{"start":{"line":59,"column":15,"offset":1470},"end":{"line":59,"column":59,"offset":1514},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">ioapicinit()</code>","position":{"start":{"line":59,"column":59,"offset":1514},"end":{"line":59,"column":73,"offset":1528},"indent":[]}},{"type":"text","value":"设置和redirection table（这是啥。。。）相关的中断。最后","position":{"start":{"line":59,"column":73,"offset":1528},"end":{"line":59,"column":109,"offset":1564},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">tvinit()</code>","position":{"start":{"line":59,"column":109,"offset":1564},"end":{"line":59,"column":119,"offset":1574},"indent":[]}},{"type":"text","value":"用","position":{"start":{"line":59,"column":119,"offset":1574},"end":{"line":59,"column":120,"offset":1575},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">SETGATE</code>","position":{"start":{"line":59,"column":120,"offset":1575},"end":{"line":59,"column":129,"offset":1584},"indent":[]}},{"type":"text","value":"这个宏来把vector number指向code at vector","position":{"start":{"line":59,"column":129,"offset":1584},"end":{"line":59,"column":163,"offset":1618},"indent":[]}},{"type":"linkReference","identifier":"i","label":"i","referenceType":"shortcut","children":[{"type":"text","value":"i","position":{"start":{"line":59,"column":164,"offset":1619},"end":{"line":59,"column":165,"offset":1620},"indent":[]}}],"position":{"start":{"line":59,"column":163,"offset":1618},"end":{"line":59,"column":166,"offset":1621},"indent":[]}},{"type":"text","value":"，也就是vector number对应的中断发生的时候需要运行的代码。","position":{"start":{"line":59,"column":166,"offset":1621},"end":{"line":59,"column":201,"offset":1656},"indent":[]}}],"position":{"start":{"line":59,"column":1,"offset":1456},"end":{"line":59,"column":201,"offset":1656},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"下面来看一下具体的代码：","position":{"start":{"line":61,"column":1,"offset":1658},"end":{"line":61,"column":13,"offset":1670},"indent":[]}}],"position":{"start":{"line":61,"column":1,"offset":1658},"end":{"line":61,"column":13,"offset":1670},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"首先是","position":{"start":{"line":63,"column":1,"offset":1672},"end":{"line":63,"column":4,"offset":1675},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">lapicinit()</code>","position":{"start":{"line":63,"column":4,"offset":1675},"end":{"line":63,"column":17,"offset":1688},"indent":[]}},{"type":"text","value":"，这个函数里面是像这样的方式设置：","position":{"start":{"line":63,"column":17,"offset":1688},"end":{"line":63,"column":34,"offset":1705},"indent":[]}}],"position":{"start":{"line":63,"column":1,"offset":1672},"end":{"line":63,"column":34,"offset":1705},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">lapicw</span><span class=\"token punctuation\">(</span>TIMER<span class=\"token punctuation\">,</span> PERIODIC <span class=\"token operator\">|</span> <span class=\"token punctuation\">(</span>T_IRQ0 <span class=\"token operator\">+</span> IRQ_TIMER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":65,"column":1,"offset":1707},"end":{"line":67,"column":4,"offset":1763},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"而这个函数是：","position":{"start":{"line":69,"column":1,"offset":1765},"end":{"line":69,"column":8,"offset":1772},"indent":[]}}],"position":{"start":{"line":69,"column":1,"offset":1765},"end":{"line":69,"column":8,"offset":1772},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">volatile</span> uint <span class=\"token operator\">*</span>lapic<span class=\"token punctuation\">;</span>  <span class=\"token comment\">// Initialized in mp.c</span>\n\n<span class=\"token comment\">//PAGEBREAK!</span>\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span>\n<span class=\"token function\">lapicw</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> index<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> value<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  lapic<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> value<span class=\"token punctuation\">;</span>\n  lapic<span class=\"token punctuation\">[</span>ID<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// wait for write to finish, by reading</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":71,"column":1,"offset":1774},"end":{"line":81,"column":4,"offset":1965},"indent":[1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"这里的","position":{"start":{"line":83,"column":1,"offset":1967},"end":{"line":83,"column":4,"offset":1970},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">lapic</code>","position":{"start":{"line":83,"column":4,"offset":1970},"end":{"line":83,"column":11,"offset":1977},"indent":[]}},{"type":"text","value":"的地址在","position":{"start":{"line":83,"column":11,"offset":1977},"end":{"line":83,"column":15,"offset":1981},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">mp.c/mpinit()</code>","position":{"start":{"line":83,"column":15,"offset":1981},"end":{"line":83,"column":30,"offset":1996},"indent":[]}},{"type":"text","value":"中初始化了。","position":{"start":{"line":83,"column":30,"offset":1996},"end":{"line":83,"column":36,"offset":2002},"indent":[]}}],"position":{"start":{"line":83,"column":1,"offset":1967},"end":{"line":83,"column":36,"offset":2002},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"然后看一下","position":{"start":{"line":85,"column":1,"offset":2004},"end":{"line":85,"column":6,"offset":2009},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">tvinit()</code>","position":{"start":{"line":85,"column":6,"offset":2009},"end":{"line":85,"column":16,"offset":2019},"indent":[]}},{"type":"text","value":"：","position":{"start":{"line":85,"column":16,"offset":2019},"end":{"line":85,"column":17,"offset":2020},"indent":[]}}],"position":{"start":{"line":85,"column":1,"offset":2004},"end":{"line":85,"column":17,"offset":2020},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">extern</span> uint vectors<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// in vectors.S: array of 256 entry pointers</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">void</span>\n<span class=\"token function\">tvinit</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">256</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span>\n    <span class=\"token function\">SETGATE</span><span class=\"token punctuation\">(</span>idt<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> SEG_KCODE<span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> vectors<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">SETGATE</span><span class=\"token punctuation\">(</span>idt<span class=\"token punctuation\">[</span>T_SYSCALL<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> SEG_KCODE<span class=\"token operator\">&lt;&lt;</span><span class=\"token number\">3</span><span class=\"token punctuation\">,</span> vectors<span class=\"token punctuation\">[</span>T_SYSCALL<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> DPL_USER<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function\">initlock</span><span class=\"token punctuation\">(</span><span class=\"token operator\">&amp;</span>tickslock<span class=\"token punctuation\">,</span> <span class=\"token string\">\"time\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":87,"column":1,"offset":2022},"end":{"line":101,"column":4,"offset":2322},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"上面的这个","position":{"start":{"line":103,"column":1,"offset":2324},"end":{"line":103,"column":6,"offset":2329},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">vectors</code>","position":{"start":{"line":103,"column":6,"offset":2329},"end":{"line":103,"column":15,"offset":2338},"indent":[]}},{"type":"text","value":"中的某一个指会对应如下的一段汇编，如：","position":{"start":{"line":103,"column":15,"offset":2338},"end":{"line":103,"column":34,"offset":2357},"indent":[]}}],"position":{"start":{"line":103,"column":1,"offset":2324},"end":{"line":103,"column":34,"offset":2357},"indent":[]}},{"type":"html","lang":"assembly","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"assembly\"><pre class=\"language-assembly\"><code class=\"language-assembly\"># vector.S\n.globl vector32\nvector32:\n  pushl $0\n  pushl $32\n  jmp alltraps</code></pre></div>","position":{"start":{"line":105,"column":1,"offset":2359},"end":{"line":112,"column":4,"offset":2449},"indent":[1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">vector.S</code>","position":{"start":{"line":114,"column":1,"offset":2451},"end":{"line":114,"column":11,"offset":2461},"indent":[]}},{"type":"text","value":"是由","position":{"start":{"line":114,"column":11,"offset":2461},"end":{"line":114,"column":13,"offset":2463},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">vector.pl</code>","position":{"start":{"line":114,"column":13,"offset":2463},"end":{"line":114,"column":24,"offset":2474},"indent":[]}},{"type":"text","value":"生成的（貌似之前提到过）。先","position":{"start":{"line":114,"column":24,"offset":2474},"end":{"line":114,"column":38,"offset":2488},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">pushl</code>","position":{"start":{"line":114,"column":38,"offset":2488},"end":{"line":114,"column":45,"offset":2495},"indent":[]}},{"type":"text","value":"一个fakes \"error\" slot in trapframe（应该是指","position":{"start":{"line":114,"column":45,"offset":2495},"end":{"line":114,"column":83,"offset":2533},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">$0</code>","position":{"start":{"line":114,"column":83,"offset":2533},"end":{"line":114,"column":87,"offset":2537},"indent":[]}},{"type":"text","value":"了），因为硬件对于某些trap并不push（没懂）。第二个","position":{"start":{"line":114,"column":87,"offset":2537},"end":{"line":114,"column":116,"offset":2566},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">pushl</code>","position":{"start":{"line":114,"column":116,"offset":2566},"end":{"line":114,"column":123,"offset":2573},"indent":[]}},{"type":"text","value":"就是vector number了，对应","position":{"start":{"line":114,"column":123,"offset":2573},"end":{"line":114,"column":142,"offset":2592},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">tf-&gt;trapno</code>","position":{"start":{"line":114,"column":142,"offset":2592},"end":{"line":114,"column":154,"offset":2604},"indent":[]}},{"type":"text","value":"。","position":{"start":{"line":114,"column":154,"offset":2604},"end":{"line":114,"column":155,"offset":2605},"indent":[]}}],"position":{"start":{"line":114,"column":1,"offset":2451},"end":{"line":114,"column":155,"offset":2605},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"下面的这个","position":{"start":{"line":116,"column":1,"offset":2607},"end":{"line":116,"column":6,"offset":2612},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">SETGATE</code>","position":{"start":{"line":116,"column":6,"offset":2612},"end":{"line":116,"column":15,"offset":2621},"indent":[]}},{"type":"text","value":"宏是上面用来设置IDT里面的每个vector用的。","position":{"start":{"line":116,"column":15,"offset":2621},"end":{"line":116,"column":40,"offset":2646},"indent":[]}}],"position":{"start":{"line":116,"column":1,"offset":2607},"end":{"line":116,"column":40,"offset":2646},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token comment\">// Set up a normal interrupt/trap gate descriptor.</span>\n<span class=\"token comment\">// - istrap: 1 for a trap (= exception) gate, 0 for an interrupt gate.</span>\n<span class=\"token comment\">//   interrupt gate clears FL_IF, trap gate leaves FL_IF alone</span>\n<span class=\"token comment\">// - sel: Code segment selector for interrupt/trap handler</span>\n<span class=\"token comment\">// - off: Offset in code segment for interrupt/trap handler</span>\n<span class=\"token comment\">// - dpl: Descriptor Privilege Level -</span>\n<span class=\"token comment\">//        the privilege level required for software to invoke</span>\n<span class=\"token comment\">//        this interrupt/trap gate explicitly using an int instruction.</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> SETGATE(gate, istrap, sel, off, d)                \\\n{                                                         \\\n  (gate).off_15_0 = (uint)(off) &amp; 0xffff;                \\\n  (gate).cs = (sel);                                      \\\n  (gate).args = 0;                                        \\\n  (gate).rsv1 = 0;                                        \\\n  (gate).type = (istrap) ? STS_TG32 : STS_IG32;           \\\n  (gate).s = 0;                                           \\\n  (gate).dpl = (d);                                       \\\n  (gate).p = 1;                                           \\\n  (gate).off_31_16 = (uint)(off) >> 16;                  \\\n}</span></code></pre></div>","position":{"start":{"line":118,"column":1,"offset":2648},"end":{"line":139,"column":4,"offset":3793},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"设置好之后就可以让中断跳进","position":{"start":{"line":141,"column":1,"offset":3795},"end":{"line":141,"column":14,"offset":3808},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">alltraps</code>","position":{"start":{"line":141,"column":14,"offset":3808},"end":{"line":141,"column":24,"offset":3818},"indent":[]}},{"type":"text","value":"了。","position":{"start":{"line":141,"column":24,"offset":3818},"end":{"line":141,"column":26,"offset":3820},"indent":[]}}],"position":{"start":{"line":141,"column":1,"offset":3795},"end":{"line":141,"column":26,"offset":3820},"indent":[]}},{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">tvinit</code>","position":{"start":{"line":143,"column":1,"offset":3822},"end":{"line":143,"column":9,"offset":3830},"indent":[]}},{"type":"text","value":"中大多数都是机械性的设置，唯有","position":{"start":{"line":143,"column":9,"offset":3830},"end":{"line":143,"column":24,"offset":3845},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">T_SYSCALL</code>","position":{"start":{"line":143,"column":24,"offset":3845},"end":{"line":143,"column":35,"offset":3856},"indent":[]}},{"type":"text","value":"里面设置了","position":{"start":{"line":143,"column":35,"offset":3856},"end":{"line":143,"column":40,"offset":3861},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">istrap=1</code>","position":{"start":{"line":143,"column":40,"offset":3861},"end":{"line":143,"column":50,"offset":3871},"indent":[]}},{"type":"text","value":"，也就是让系统在进行system call的时候仍然","position":{"start":{"line":143,"column":50,"offset":3871},"end":{"line":143,"column":76,"offset":3897},"indent":[]}},{"type":"strong","children":[{"type":"text","value":"保留中断","position":{"start":{"line":143,"column":78,"offset":3899},"end":{"line":143,"column":82,"offset":3903},"indent":[]}}],"position":{"start":{"line":143,"column":76,"offset":3897},"end":{"line":143,"column":84,"offset":3905},"indent":[]}},{"type":"text","value":"，而其他的device interrupt就不保留了。","position":{"start":{"line":143,"column":84,"offset":3905},"end":{"line":143,"column":111,"offset":3932},"indent":[]}}],"position":{"start":{"line":143,"column":1,"offset":3822},"end":{"line":143,"column":111,"offset":3932},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"思考两个问题（我现在还不明白...）","position":{"start":{"line":145,"column":1,"offset":3934},"end":{"line":145,"column":19,"offset":3952},"indent":[]}}],"position":{"start":{"line":145,"column":1,"offset":3934},"end":{"line":145,"column":19,"offset":3952},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"为什么在system call的过程中允许中断？","position":{"start":{"line":147,"column":3,"offset":3956},"end":{"line":147,"column":27,"offset":3980},"indent":[]}}],"position":{"start":{"line":147,"column":3,"offset":3956},"end":{"line":147,"column":27,"offset":3980},"indent":[]}}],"position":{"start":{"line":147,"column":1,"offset":3954},"end":{"line":147,"column":27,"offset":3980},"indent":[]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"为什么在interrupt handing之中disable interrupt。","position":{"start":{"line":148,"column":3,"offset":3983},"end":{"line":148,"column":44,"offset":4024},"indent":[]}}],"position":{"start":{"line":148,"column":3,"offset":3983},"end":{"line":148,"column":44,"offset":4024},"indent":[]}}],"position":{"start":{"line":148,"column":1,"offset":3981},"end":{"line":148,"column":44,"offset":4024},"indent":[]}}],"position":{"start":{"line":147,"column":1,"offset":3954},"end":{"line":148,"column":44,"offset":4024},"indent":[1]}},{"type":"paragraph","children":[{"type":"text","value":"硬件如何知道interrupt里面调用的代码该用user stack还是kernel stack（例如hw xv6 cpu alarm就是用user space）？","position":{"start":{"line":150,"column":1,"offset":4026},"end":{"line":150,"column":83,"offset":4108},"indent":[]}}],"position":{"start":{"line":150,"column":1,"offset":4026},"end":{"line":150,"column":83,"offset":4108},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"当因为中断从user space到kernel space的时候，hardware-defined TSS (task state segment) 让kernel获取CPU的一些详细信息，如寄存器状态，I/O permission之类的。这样就可以知道是应该使用哪个stack了。","position":{"start":{"line":152,"column":3,"offset":4112},"end":{"line":152,"column":144,"offset":4253},"indent":[]}}],"position":{"start":{"line":152,"column":3,"offset":4112},"end":{"line":152,"column":144,"offset":4253},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"TSS是one per CPU，从而使得不同CPU可以运行不同的进程，并take traps on different stacks","position":{"start":{"line":154,"column":5,"offset":4259},"end":{"line":154,"column":71,"offset":4325},"indent":[]}}],"position":{"start":{"line":154,"column":5,"offset":4259},"end":{"line":154,"column":71,"offset":4325},"indent":[]}}],"position":{"start":{"line":154,"column":3,"offset":4257},"end":{"line":154,"column":71,"offset":4325},"indent":[]}}],"position":{"start":{"line":154,"column":3,"offset":4257},"end":{"line":154,"column":71,"offset":4325},"indent":[]}}],"position":{"start":{"line":152,"column":1,"offset":4110},"end":{"line":154,"column":71,"offset":4325},"indent":[1,1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">proc.c/scheduler()</code>","position":{"start":{"line":155,"column":3,"offset":4328},"end":{"line":155,"column":23,"offset":4348},"indent":[]}},{"type":"text","value":": one per CPU","position":{"start":{"line":155,"column":23,"offset":4348},"end":{"line":155,"column":36,"offset":4361},"indent":[]}}],"position":{"start":{"line":155,"column":3,"offset":4328},"end":{"line":155,"column":36,"offset":4361},"indent":[]}}],"position":{"start":{"line":155,"column":1,"offset":4326},"end":{"line":155,"column":36,"offset":4361},"indent":[]}},{"type":"listItem","spread":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"html","value":"<code class=\"language-text\">vm.c/switchuvm()</code>","position":{"start":{"line":156,"column":3,"offset":4364},"end":{"line":156,"column":21,"offset":4382},"indent":[]}}],"position":{"start":{"line":156,"column":3,"offset":4364},"end":{"line":156,"column":21,"offset":4382},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"tells CPU what kernel stack to use","position":{"start":{"line":158,"column":3,"offset":4386},"end":{"line":158,"column":37,"offset":4420},"indent":[]}}],"position":{"start":{"line":158,"column":3,"offset":4386},"end":{"line":158,"column":37,"offset":4420},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"tells kernel what page table to use","position":{"start":{"line":160,"column":3,"offset":4424},"end":{"line":160,"column":38,"offset":4459},"indent":[]}}],"position":{"start":{"line":160,"column":3,"offset":4424},"end":{"line":160,"column":38,"offset":4459},"indent":[]}}],"position":{"start":{"line":156,"column":1,"offset":4362},"end":{"line":160,"column":38,"offset":4459},"indent":[1,1,1,1]}}],"position":{"start":{"line":152,"column":1,"offset":4110},"end":{"line":160,"column":38,"offset":4459},"indent":[1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"在trapping into kernel之前，CPU应该把","position":{"start":{"line":162,"column":1,"offset":4461},"end":{"line":162,"column":31,"offset":4491},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">eip</code>","position":{"start":{"line":162,"column":31,"offset":4491},"end":{"line":162,"column":36,"offset":4496},"indent":[]}},{"type":"text","value":"保存为正在运行的instruct。","position":{"start":{"line":162,"column":36,"offset":4496},"end":{"line":162,"column":53,"offset":4513},"indent":[]}}],"position":{"start":{"line":162,"column":1,"offset":4461},"end":{"line":162,"column":53,"offset":4513},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这中间有很长一部分是讲解cpu alarm作业的，这部分内容记录在了对应的作业的博文中。","position":{"start":{"line":164,"column":1,"offset":4515},"end":{"line":164,"column":45,"offset":4559},"indent":[]}}],"position":{"start":{"line":164,"column":1,"offset":4515},"end":{"line":164,"column":45,"offset":4559},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Interrupt more generally","position":{"start":{"line":166,"column":5,"offset":4565},"end":{"line":166,"column":29,"offset":4589},"indent":[]}}],"position":{"start":{"line":166,"column":1,"offset":4561},"end":{"line":166,"column":29,"offset":4589},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"中断引入了并行的问题：","position":{"start":{"line":168,"column":1,"offset":4591},"end":{"line":168,"column":12,"offset":4602},"indent":[]}}],"position":{"start":{"line":168,"column":1,"offset":4591},"end":{"line":168,"column":12,"offset":4602},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":true,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"因为代码运行过程中可能会有其他的代码因中断而被运行。","position":{"start":{"line":170,"column":3,"offset":4606},"end":{"line":170,"column":29,"offset":4632},"indent":[]}}],"position":{"start":{"line":170,"column":3,"offset":4606},"end":{"line":170,"column":29,"offset":4632},"indent":[]}}],"position":{"start":{"line":170,"column":1,"offset":4604},"end":{"line":171,"column":1,"offset":4633},"indent":[1]}},{"type":"listItem","spread":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"对于用户代码来说，因为kernel会存储状态，所以影响不大，但是对于kernel代码来说，就可能很糟糕了。","position":{"start":{"line":172,"column":3,"offset":4636},"end":{"line":172,"column":56,"offset":4689},"indent":[]}}],"position":{"start":{"line":172,"column":3,"offset":4636},"end":{"line":172,"column":56,"offset":4689},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"例如：","position":{"start":{"line":174,"column":3,"offset":4693},"end":{"line":174,"column":6,"offset":4696},"indent":[]}}],"position":{"start":{"line":174,"column":3,"offset":4693},"end":{"line":174,"column":6,"offset":4696},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">my code<span class=\"token operator\">:</span>               interrupt<span class=\"token operator\">:</span>\n    <span class=\"token operator\">%</span>eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n    <span class=\"token keyword\">if</span> <span class=\"token operator\">%</span>eax <span class=\"token operator\">=</span> <span class=\"token number\">0</span> then        <span class=\"token operator\">%</span>eax <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n      <span class=\"token function\">f</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span></code></pre></div>","position":{"start":{"line":176,"column":3,"offset":4700},"end":{"line":181,"column":6,"offset":4818},"indent":[3,5,5,5,3]}},{"type":"paragraph","children":[{"type":"text","value":"我们不知道","position":{"start":{"line":183,"column":3,"offset":4822},"end":{"line":183,"column":8,"offset":4827},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">f</code>","position":{"start":{"line":183,"column":8,"offset":4827},"end":{"line":183,"column":11,"offset":4830},"indent":[]}},{"type":"text","value":"是不是被执行了。","position":{"start":{"line":183,"column":11,"offset":4830},"end":{"line":183,"column":19,"offset":4838},"indent":[]}}],"position":{"start":{"line":183,"column":3,"offset":4822},"end":{"line":183,"column":19,"offset":4838},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"所以为了让一段代码","position":{"start":{"line":185,"column":3,"offset":4842},"end":{"line":185,"column":12,"offset":4851},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">atomic</code>","position":{"start":{"line":185,"column":12,"offset":4851},"end":{"line":185,"column":20,"offset":4859},"indent":[]}},{"type":"text","value":"，我们需要关闭中断，也就是使用","position":{"start":{"line":185,"column":20,"offset":4859},"end":{"line":185,"column":35,"offset":4874},"indent":[]}}],"position":{"start":{"line":185,"column":3,"offset":4842},"end":{"line":185,"column":35,"offset":4874},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token function\">cli</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 和汇编中的cli，也就是clear interrupt同义</span>\n<span class=\"token function\">sti</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>  <span class=\"token comment\">// 和汇编中的sti，也就是set interrupt同以</span></code></pre></div>","position":{"start":{"line":187,"column":3,"offset":4878},"end":{"line":190,"column":6,"offset":4970},"indent":[3,3,3]}}],"position":{"start":{"line":172,"column":1,"offset":4634},"end":{"line":190,"column":6,"offset":4970},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}}],"position":{"start":{"line":170,"column":1,"offset":4604},"end":{"line":190,"column":6,"offset":4970},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"这是我们对并行的初探，之后讨论锁的时候还会再来讨论。","position":{"start":{"line":192,"column":1,"offset":4972},"end":{"line":192,"column":27,"offset":4998},"indent":[]}}],"position":{"start":{"line":192,"column":1,"offset":4972},"end":{"line":192,"column":27,"offset":4998},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"Interrupt evolution","position":{"start":{"line":194,"column":1,"offset":5000},"end":{"line":194,"column":20,"offset":5019},"indent":[]}}],"position":{"start":{"line":194,"column":1,"offset":5000},"end":{"line":194,"column":20,"offset":5019},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":true,"children":[{"type":"listItem","spread":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Interrupt在归去是相对快的，现在却是相对慢的了。","position":{"start":{"line":196,"column":3,"offset":5023},"end":{"line":196,"column":31,"offset":5051},"indent":[]}}],"position":{"start":{"line":196,"column":3,"offset":5023},"end":{"line":196,"column":31,"offset":5051},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"因为老的方法是所有事件都会触法中断，硬件简单，软件智能。","position":{"start":{"line":198,"column":3,"offset":5055},"end":{"line":198,"column":31,"offset":5083},"indent":[]}}],"position":{"start":{"line":198,"column":3,"offset":5055},"end":{"line":198,"column":31,"offset":5083},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"而新的方法是硬件在中断之前会事先完成一些工作。","position":{"start":{"line":200,"column":3,"offset":5087},"end":{"line":200,"column":26,"offset":5110},"indent":[]}}],"position":{"start":{"line":200,"column":3,"offset":5087},"end":{"line":200,"column":26,"offset":5110},"indent":[]}}],"position":{"start":{"line":196,"column":1,"offset":5021},"end":{"line":201,"column":1,"offset":5111},"indent":[1,1,1,1,1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"一些设备可以在不到1微秒的时间内生成中断。比如GB ethernet。","position":{"start":{"line":202,"column":3,"offset":5114},"end":{"line":202,"column":38,"offset":5149},"indent":[]}}],"position":{"start":{"line":202,"column":3,"offset":5114},"end":{"line":202,"column":38,"offset":5149},"indent":[]}}],"position":{"start":{"line":202,"column":1,"offset":5112},"end":{"line":203,"column":1,"offset":5150},"indent":[1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"而中断却需要大约微妙时间量级。因为需要保存和恢复状态，同时中断伴随着cache misses。","position":{"start":{"line":204,"column":3,"offset":5153},"end":{"line":204,"column":50,"offset":5200},"indent":[]}}],"position":{"start":{"line":204,"column":3,"offset":5153},"end":{"line":204,"column":50,"offset":5200},"indent":[]}}],"position":{"start":{"line":204,"column":1,"offset":5151},"end":{"line":205,"column":1,"offset":5201},"indent":[1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"那么我们该如何处理间隔小于1微秒的中断呢？","position":{"start":{"line":206,"column":3,"offset":5204},"end":{"line":206,"column":24,"offset":5225},"indent":[]}}],"position":{"start":{"line":206,"column":3,"offset":5204},"end":{"line":206,"column":24,"offset":5225},"indent":[]}}],"position":{"start":{"line":206,"column":1,"offset":5202},"end":{"line":206,"column":24,"offset":5225},"indent":[]}}],"position":{"start":{"line":196,"column":1,"offset":5021},"end":{"line":206,"column":24,"offset":5225},"indent":[1,1,1,1,1,1,1,1,1,1]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Polling: 另一种和设备交互的方法。","position":{"start":{"line":208,"column":5,"offset":5231},"end":{"line":208,"column":26,"offset":5252},"indent":[]}}],"position":{"start":{"line":208,"column":1,"offset":5227},"end":{"line":208,"column":26,"offset":5252},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":false,"children":[{"type":"listItem","spread":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"处理器spin until device wants attention（按一定周期检查设备是否有需要）","position":{"start":{"line":210,"column":3,"offset":5256},"end":{"line":210,"column":55,"offset":5308},"indent":[]}}],"position":{"start":{"line":210,"column":3,"offset":5256},"end":{"line":210,"column":55,"offset":5308},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这种方法虽然在设备很慢的时候很浪费，但是设备很快的时候就很好了，因为不需要保存寄存器等等。","position":{"start":{"line":212,"column":3,"offset":5312},"end":{"line":212,"column":48,"offset":5357},"indent":[]}}],"position":{"start":{"line":212,"column":3,"offset":5312},"end":{"line":212,"column":48,"offset":5357},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"If events are always waiting, not need to keep alerting the software. (这句没懂)","position":{"start":{"line":214,"column":3,"offset":5361},"end":{"line":214,"column":79,"offset":5437},"indent":[]}}],"position":{"start":{"line":214,"column":3,"offset":5361},"end":{"line":214,"column":79,"offset":5437},"indent":[]}}],"position":{"start":{"line":210,"column":1,"offset":5254},"end":{"line":214,"column":79,"offset":5437},"indent":[1,1,1,1]}}],"position":{"start":{"line":210,"column":1,"offset":5254},"end":{"line":214,"column":79,"offset":5437},"indent":[1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"Polling versus Interrupt","position":{"start":{"line":216,"column":1,"offset":5439},"end":{"line":216,"column":25,"offset":5463},"indent":[]}}],"position":{"start":{"line":216,"column":1,"offset":5439},"end":{"line":216,"column":25,"offset":5463},"indent":[]}},{"type":"list","ordered":false,"start":null,"spread":true,"children":[{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"对high-rate device用polling，慢的用interrupt","position":{"start":{"line":218,"column":3,"offset":5467},"end":{"line":218,"column":41,"offset":5505},"indent":[]}}],"position":{"start":{"line":218,"column":3,"offset":5467},"end":{"line":218,"column":41,"offset":5505},"indent":[]}}],"position":{"start":{"line":218,"column":1,"offset":5465},"end":{"line":219,"column":1,"offset":5506},"indent":[1]}},{"type":"listItem","spread":false,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"也可以在polling和interrupt之间相互切换，如果rate is low用interrupt，反之用polling","position":{"start":{"line":220,"column":3,"offset":5509},"end":{"line":220,"column":65,"offset":5571},"indent":[]}}],"position":{"start":{"line":220,"column":3,"offset":5509},"end":{"line":220,"column":65,"offset":5571},"indent":[]}}],"position":{"start":{"line":220,"column":1,"offset":5507},"end":{"line":221,"column":1,"offset":5572},"indent":[1]}},{"type":"listItem","spread":true,"checked":null,"children":[{"type":"paragraph","children":[{"type":"text","value":"Faster forwarding of interrupts to user space（这里没明白是说polling会帮助还是interrupt可以有更好的机制）","position":{"start":{"line":222,"column":3,"offset":5575},"end":{"line":222,"column":86,"offset":5658},"indent":[]}}],"position":{"start":{"line":222,"column":3,"offset":5575},"end":{"line":222,"column":86,"offset":5658},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"for page faults and user-handled devices","position":{"start":{"line":224,"column":3,"offset":5662},"end":{"line":224,"column":43,"offset":5702},"indent":[]}}],"position":{"start":{"line":224,"column":3,"offset":5662},"end":{"line":224,"column":43,"offset":5702},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"h/w delivers directly to user, w/o kernel intervention?","position":{"start":{"line":226,"column":3,"offset":5706},"end":{"line":226,"column":58,"offset":5761},"indent":[]}}],"position":{"start":{"line":226,"column":3,"offset":5706},"end":{"line":226,"column":58,"offset":5761},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"faster forwarding path through kernel?","position":{"start":{"line":228,"column":3,"offset":5765},"end":{"line":228,"column":41,"offset":5803},"indent":[]}}],"position":{"start":{"line":228,"column":3,"offset":5765},"end":{"line":228,"column":41,"offset":5803},"indent":[]}}],"position":{"start":{"line":222,"column":1,"offset":5573},"end":{"line":228,"column":41,"offset":5803},"indent":[1,1,1,1,1,1]}}],"position":{"start":{"line":218,"column":1,"offset":5465},"end":{"line":228,"column":41,"offset":5803},"indent":[1,1,1,1,1,1,1,1,1,1]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":230,"column":1,"offset":5805}}}}