{"expireTime":9007200818315813000,"key":"transformer-remark-markdown-ast-2753bcf750ae9d52531c4a0fb7ece09a-gatsby-remark-katexgatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"heading","depth":2,"children":[{"type":"text","value":"Part One: Eliminate allocation from sbrk()","position":{"start":{"line":2,"column":4,"offset":4},"end":{"line":2,"column":46,"offset":46},"indent":[]}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":46,"offset":46},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"首先是要在","position":{"start":{"line":4,"column":1,"offset":48},"end":{"line":4,"column":6,"offset":53},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">sbrk</code>","position":{"start":{"line":4,"column":6,"offset":53},"end":{"line":4,"column":12,"offset":59},"indent":[]}},{"type":"text","value":"中去掉分配内存的部分。","position":{"start":{"line":4,"column":12,"offset":59},"end":{"line":4,"column":23,"offset":70},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">sbrk</code>","position":{"start":{"line":4,"column":23,"offset":70},"end":{"line":4,"column":29,"offset":76},"indent":[]}},{"type":"text","value":"函数原来的版本是：","position":{"start":{"line":4,"column":29,"offset":76},"end":{"line":4,"column":38,"offset":85},"indent":[]}}],"position":{"start":{"line":4,"column":1,"offset":48},"end":{"line":4,"column":38,"offset":85},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span>\n<span class=\"token function\">sys_sbrk</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> addr<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  addr <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">growproc</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":6,"column":1,"offset":87},"end":{"line":20,"column":4,"offset":254},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"可想而知，分配内存的主要方式来源于","position":{"start":{"line":22,"column":1,"offset":256},"end":{"line":22,"column":18,"offset":273},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">growproc</code>","position":{"start":{"line":22,"column":18,"offset":273},"end":{"line":22,"column":28,"offset":283},"indent":[]}},{"type":"text","value":"（在","position":{"start":{"line":22,"column":28,"offset":283},"end":{"line":22,"column":30,"offset":285},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">proc.c</code>","position":{"start":{"line":22,"column":30,"offset":285},"end":{"line":22,"column":38,"offset":293},"indent":[]}},{"type":"text","value":"），","position":{"start":{"line":22,"column":38,"offset":293},"end":{"line":22,"column":40,"offset":295},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">growpoc</code>","position":{"start":{"line":22,"column":40,"offset":295},"end":{"line":22,"column":49,"offset":304},"indent":[]}},{"type":"text","value":"就是会给当前进程的page table加n的内存，并把","position":{"start":{"line":22,"column":49,"offset":304},"end":{"line":22,"column":76,"offset":331},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">proc-&gt;sz</code>","position":{"start":{"line":22,"column":76,"offset":331},"end":{"line":22,"column":86,"offset":341},"indent":[]}},{"type":"text","value":"加","position":{"start":{"line":22,"column":86,"offset":341},"end":{"line":22,"column":87,"offset":342},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">n</code>","position":{"start":{"line":22,"column":87,"offset":342},"end":{"line":22,"column":90,"offset":345},"indent":[]}},{"type":"text","value":"。注意，阅读","position":{"start":{"line":22,"column":90,"offset":345},"end":{"line":22,"column":96,"offset":351},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">allocuvm</code>","position":{"start":{"line":22,"column":96,"offset":351},"end":{"line":22,"column":106,"offset":361},"indent":[]}},{"type":"text","value":"函数可以得知，在分配的时候不会对n或者之后的","position":{"start":{"line":22,"column":106,"offset":361},"end":{"line":22,"column":128,"offset":383},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">sz+n</code>","position":{"start":{"line":22,"column":128,"offset":383},"end":{"line":22,"column":134,"offset":389},"indent":[]}},{"type":"text","value":"，round到page size的整数倍。所以按照题目要求，我们不分配内存，只增加sz，那么就是：","position":{"start":{"line":22,"column":134,"offset":389},"end":{"line":22,"column":183,"offset":438},"indent":[]}}],"position":{"start":{"line":22,"column":1,"offset":256},"end":{"line":22,"column":183,"offset":438},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span>\n<span class=\"token function\">sys_sbrk</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> addr<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  addr <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz <span class=\"token operator\">+=</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":24,"column":1,"offset":440},"end":{"line":37,"column":4,"offset":591},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"之后，如果启动xv6，就会得到需要的结果：","position":{"start":{"line":39,"column":1,"offset":593},"end":{"line":39,"column":22,"offset":614},"indent":[]}}],"position":{"start":{"line":39,"column":1,"offset":593},"end":{"line":39,"column":22,"offset":614},"indent":[]}},{"type":"html","lang":"bash","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">init: starting sh\n$ <span class=\"token keyword\">echo</span> hi\npid 3 sh: <span class=\"token function\">trap</span> 14 err 6 on cpu 0 eip 0x112c addr 0x4004--kill proc\n$ </code></pre></div>","position":{"start":{"line":41,"column":1,"offset":616},"end":{"line":46,"column":4,"offset":725},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"这里输出的是位于","position":{"start":{"line":48,"column":1,"offset":727},"end":{"line":48,"column":9,"offset":735},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap.c</code>","position":{"start":{"line":48,"column":9,"offset":735},"end":{"line":48,"column":17,"offset":743},"indent":[]}},{"type":"text","value":"中的","position":{"start":{"line":48,"column":17,"offset":743},"end":{"line":48,"column":19,"offset":745},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">page fault</code>","position":{"start":{"line":48,"column":19,"offset":745},"end":{"line":48,"column":31,"offset":757},"indent":[]}},{"type":"text","value":"，对应的是在","position":{"start":{"line":48,"column":31,"offset":757},"end":{"line":48,"column":37,"offset":763},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap.c</code>","position":{"start":{"line":48,"column":37,"offset":763},"end":{"line":48,"column":45,"offset":771},"indent":[]}},{"type":"text","value":"中跳入","position":{"start":{"line":48,"column":45,"offset":771},"end":{"line":48,"column":48,"offset":774},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap</code>","position":{"start":{"line":48,"column":48,"offset":774},"end":{"line":48,"column":54,"offset":780},"indent":[]}},{"type":"text","value":"函数。","position":{"start":{"line":48,"column":54,"offset":780},"end":{"line":48,"column":57,"offset":783},"indent":[]}}],"position":{"start":{"line":48,"column":1,"offset":727},"end":{"line":48,"column":57,"offset":783},"indent":[]}},{"type":"heading","depth":3,"children":[{"type":"text","value":"Part Two: Lazy allocation","position":{"start":{"line":50,"column":5,"offset":789},"end":{"line":50,"column":30,"offset":814},"indent":[]}}],"position":{"start":{"line":50,"column":1,"offset":785},"end":{"line":50,"column":30,"offset":814},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"按照题目要求，在trap中加入","position":{"start":{"line":52,"column":1,"offset":816},"end":{"line":52,"column":16,"offset":831},"indent":[]}}],"position":{"start":{"line":52,"column":1,"offset":816},"end":{"line":52,"column":16,"offset":831},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\">  <span class=\"token keyword\">case</span> T_PGFLT<span class=\"token operator\">:</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// code from allocuvm</span>\n    uint newsz <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz<span class=\"token punctuation\">;</span>\n    uint a <span class=\"token operator\">=</span> <span class=\"token function\">PGROUNDDOWN</span><span class=\"token punctuation\">(</span><span class=\"token function\">rcr2</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>a <span class=\"token operator\">&lt;</span> newsz<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>mem <span class=\"token operator\">=</span> <span class=\"token function\">kalloc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>mem <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">cprintf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"out of memory\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">memset</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span><span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">char</span><span class=\"token operator\">*</span><span class=\"token punctuation\">)</span>a<span class=\"token punctuation\">,</span> PGSIZE<span class=\"token punctuation\">,</span> <span class=\"token function\">V2P</span><span class=\"token punctuation\">(</span>mem<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> PTE_W<span class=\"token operator\">|</span>PTE_U<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":54,"column":1,"offset":833},"end":{"line":72,"column":4,"offset":1220},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"中间的代码都是由","position":{"start":{"line":74,"column":1,"offset":1222},"end":{"line":74,"column":9,"offset":1230},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">allocuvm</code>","position":{"start":{"line":74,"column":9,"offset":1230},"end":{"line":74,"column":19,"offset":1240},"indent":[]}},{"type":"text","value":"学来的，注意因为是lazy allocation所以只需要分配一个pagesize就可以了，同时a要","position":{"start":{"line":74,"column":19,"offset":1240},"end":{"line":74,"column":69,"offset":1290},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">PGROUNDDOWN</code>","position":{"start":{"line":74,"column":69,"offset":1290},"end":{"line":74,"column":82,"offset":1303},"indent":[]}},{"type":"text","value":"，而不是","position":{"start":{"line":74,"column":82,"offset":1303},"end":{"line":74,"column":86,"offset":1307},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">PGROUNDUP</code>","position":{"start":{"line":74,"column":86,"offset":1307},"end":{"line":74,"column":97,"offset":1318},"indent":[]}},{"type":"text","value":"。应该是因为在","position":{"start":{"line":74,"column":97,"offset":1318},"end":{"line":74,"column":104,"offset":1325},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">allocuvm</code>","position":{"start":{"line":74,"column":104,"offset":1325},"end":{"line":74,"column":114,"offset":1335},"indent":[]}},{"type":"text","value":"里面，传入的量是","position":{"start":{"line":74,"column":114,"offset":1335},"end":{"line":74,"column":122,"offset":1343},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">myproc()-&gt;sz</code>","position":{"start":{"line":74,"column":122,"offset":1343},"end":{"line":74,"column":136,"offset":1357},"indent":[]}},{"type":"text","value":"，是4096的倍数，而通过","position":{"start":{"line":74,"column":136,"offset":1357},"end":{"line":74,"column":149,"offset":1370},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">rcr2</code>","position":{"start":{"line":74,"column":149,"offset":1370},"end":{"line":74,"column":155,"offset":1376},"indent":[]}},{"type":"text","value":"得到的是第一个没有被分配的地址。可以共下面的这个我加了两行","position":{"start":{"line":74,"column":155,"offset":1376},"end":{"line":74,"column":184,"offset":1405},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">cprintf</code>","position":{"start":{"line":74,"column":184,"offset":1405},"end":{"line":74,"column":193,"offset":1414},"indent":[]}},{"type":"text","value":"的输出中看出来。","position":{"start":{"line":74,"column":193,"offset":1414},"end":{"line":74,"column":201,"offset":1422},"indent":[]}}],"position":{"start":{"line":74,"column":1,"offset":1222},"end":{"line":74,"column":201,"offset":1422},"indent":[]}},{"type":"html","lang":"bash","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token keyword\">echo</span> hi\naddr: 16384\nrcr2<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>: 16388\nhi</code></pre></div>","position":{"start":{"line":76,"column":1,"offset":1424},"end":{"line":81,"column":4,"offset":1474},"indent":[1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"所以，如果在","position":{"start":{"line":83,"column":1,"offset":1476},"end":{"line":83,"column":7,"offset":1482},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap</code>","position":{"start":{"line":83,"column":7,"offset":1482},"end":{"line":83,"column":13,"offset":1488},"indent":[]}},{"type":"text","value":"中仍然用","position":{"start":{"line":83,"column":13,"offset":1488},"end":{"line":83,"column":17,"offset":1492},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">PGROUNDUP</code>","position":{"start":{"line":83,"column":17,"offset":1492},"end":{"line":83,"column":28,"offset":1503},"indent":[]}},{"type":"text","value":"就会跳过去一个page了。但是为什么如果写错了触发的错误是","position":{"start":{"line":83,"column":28,"offset":1503},"end":{"line":83,"column":57,"offset":1532},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">mappages</code>","position":{"start":{"line":83,"column":57,"offset":1532},"end":{"line":83,"column":67,"offset":1542},"indent":[]}},{"type":"text","value":"中的","position":{"start":{"line":83,"column":67,"offset":1542},"end":{"line":83,"column":69,"offset":1544},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">panic(remap)</code>","position":{"start":{"line":83,"column":69,"offset":1544},"end":{"line":83,"column":83,"offset":1558},"indent":[]}},{"type":"text","value":"我就不明白了。","position":{"start":{"line":83,"column":83,"offset":1558},"end":{"line":83,"column":90,"offset":1565},"indent":[]}}],"position":{"start":{"line":83,"column":1,"offset":1476},"end":{"line":83,"column":90,"offset":1565},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"然后为了能访问","position":{"start":{"line":85,"column":1,"offset":1567},"end":{"line":85,"column":8,"offset":1574},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">mappages</code>","position":{"start":{"line":85,"column":8,"offset":1574},"end":{"line":85,"column":18,"offset":1584},"indent":[]}},{"type":"text","value":"，在","position":{"start":{"line":85,"column":18,"offset":1584},"end":{"line":85,"column":20,"offset":1586},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap.c</code>","position":{"start":{"line":85,"column":20,"offset":1586},"end":{"line":85,"column":28,"offset":1594},"indent":[]}},{"type":"text","value":"的最上面声明了","position":{"start":{"line":85,"column":28,"offset":1594},"end":{"line":85,"column":35,"offset":1601},"indent":[]}}],"position":{"start":{"line":85,"column":1,"offset":1567},"end":{"line":85,"column":35,"offset":1601},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">extern</span> <span class=\"token keyword\">int</span> <span class=\"token function\">mappages</span><span class=\"token punctuation\">(</span>pde_t <span class=\"token operator\">*</span>pgdir<span class=\"token punctuation\">,</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">*</span>va<span class=\"token punctuation\">,</span> uint size<span class=\"token punctuation\">,</span> uint pa<span class=\"token punctuation\">,</span> <span class=\"token keyword\">int</span> perm<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":87,"column":1,"offset":1603},"end":{"line":89,"column":4,"offset":1686},"indent":[1,1]}},{"type":"paragraph","children":[{"type":"text","value":"同时把其定义处的","position":{"start":{"line":91,"column":1,"offset":1688},"end":{"line":91,"column":9,"offset":1696},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">static</code>","position":{"start":{"line":91,"column":9,"offset":1696},"end":{"line":91,"column":17,"offset":1704},"indent":[]}},{"type":"text","value":"去掉。","position":{"start":{"line":91,"column":17,"offset":1704},"end":{"line":91,"column":20,"offset":1707},"indent":[]}}],"position":{"start":{"line":91,"column":1,"offset":1688},"end":{"line":91,"column":20,"offset":1707},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"然后为了实现Optional Challenges，把","position":{"start":{"line":93,"column":1,"offset":1709},"end":{"line":93,"column":28,"offset":1736},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">sbrk</code>","position":{"start":{"line":93,"column":28,"offset":1736},"end":{"line":93,"column":34,"offset":1742},"indent":[]}},{"type":"text","value":"改为：","position":{"start":{"line":93,"column":34,"offset":1742},"end":{"line":93,"column":37,"offset":1745},"indent":[]}}],"position":{"start":{"line":93,"column":1,"offset":1709},"end":{"line":93,"column":37,"offset":1745},"indent":[]}},{"type":"html","lang":"c","meta":null,"value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">int</span>\n<span class=\"token function\">sys_sbrk</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> addr<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">int</span> n<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">argint</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  addr <span class=\"token operator\">=</span> <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>n <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>  <span class=\"token comment\">// when n &lt; 0, there is no lazy allocation</span>\n    <span class=\"token comment\">// 注意，growproc在释放没有被分配的内存的时候会直接跳过去，不会报错</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">growproc</span><span class=\"token punctuation\">(</span>n<span class=\"token punctuation\">)</span> <span class=\"token operator\">&lt;</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz <span class=\"token operator\">+</span> n <span class=\"token operator\">>=</span> KERNBASE<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">myproc</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-></span>sz <span class=\"token operator\">+=</span> n<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> addr<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":95,"column":1,"offset":1747},"end":{"line":116,"column":4,"offset":2112},"indent":[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]}},{"type":"paragraph","children":[{"type":"text","value":"从而实现了负数和大数的限制。没有写测试...所以不能确定对。","position":{"start":{"line":118,"column":1,"offset":2114},"end":{"line":118,"column":31,"offset":2144},"indent":[]}}],"position":{"start":{"line":118,"column":1,"offset":2114},"end":{"line":118,"column":31,"offset":2144},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"这里顺便记录一下xv6是如何调用","position":{"start":{"line":120,"column":1,"offset":2146},"end":{"line":120,"column":17,"offset":2162},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap</code>","position":{"start":{"line":120,"column":17,"offset":2162},"end":{"line":120,"column":23,"offset":2168},"indent":[]}},{"type":"text","value":"的。之前在讲system call的时候，说过是因为调用了","position":{"start":{"line":120,"column":23,"offset":2168},"end":{"line":120,"column":52,"offset":2197},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">int</code>","position":{"start":{"line":120,"column":52,"offset":2197},"end":{"line":120,"column":57,"offset":2202},"indent":[]}},{"type":"text","value":"指令。而","position":{"start":{"line":120,"column":57,"offset":2202},"end":{"line":120,"column":61,"offset":2206},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">page fault</code>","position":{"start":{"line":120,"column":61,"offset":2206},"end":{"line":120,"column":73,"offset":2218},"indent":[]}},{"type":"text","value":"这样的中断呢？","position":{"start":{"line":120,"column":73,"offset":2218},"end":{"line":120,"column":80,"offset":2225},"indent":[]}}],"position":{"start":{"line":120,"column":1,"offset":2146},"end":{"line":120,"column":80,"offset":2225},"indent":[]}},{"type":"paragraph","children":[{"type":"text","value":"x86有一个特殊的table称为interrupt descriptot table(IDT)，其为一个function handler的数组。这个数组里面调用的函数都在","position":{"start":{"line":122,"column":1,"offset":2227},"end":{"line":122,"column":86,"offset":2312},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">vector.S</code>","position":{"start":{"line":122,"column":86,"offset":2312},"end":{"line":122,"column":96,"offset":2322},"indent":[]}},{"type":"text","value":"中定义了。（注意","position":{"start":{"line":122,"column":96,"offset":2322},"end":{"line":122,"column":104,"offset":2330},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">vector.S</code>","position":{"start":{"line":122,"column":104,"offset":2330},"end":{"line":122,"column":114,"offset":2340},"indent":[]}},{"type":"text","value":"是由","position":{"start":{"line":122,"column":114,"offset":2340},"end":{"line":122,"column":116,"offset":2342},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">vector.pl</code>","position":{"start":{"line":122,"column":116,"offset":2342},"end":{"line":122,"column":127,"offset":2353},"indent":[]}},{"type":"text","value":"这个perl文件生成的。）每个function handler都调用了","position":{"start":{"line":122,"column":127,"offset":2353},"end":{"line":122,"column":162,"offset":2388},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">alltrap</code>","position":{"start":{"line":122,"column":162,"offset":2388},"end":{"line":122,"column":171,"offset":2397},"indent":[]}},{"type":"text","value":"从而调用","position":{"start":{"line":122,"column":171,"offset":2397},"end":{"line":122,"column":175,"offset":2401},"indent":[]}},{"type":"html","value":"<code class=\"language-text\">trap</code>","position":{"start":{"line":122,"column":175,"offset":2401},"end":{"line":122,"column":181,"offset":2407},"indent":[]}},{"type":"text","value":"。在调用之前，会把trapframe推进栈中，对于page fault这样需要特殊寄存器的中断，会多推进去一些需要的东西。","position":{"start":{"line":122,"column":181,"offset":2407},"end":{"line":122,"column":242,"offset":2468},"indent":[]}}],"position":{"start":{"line":122,"column":1,"offset":2227},"end":{"line":122,"column":242,"offset":2468},"indent":[]}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":122,"column":242,"offset":2468}}}}