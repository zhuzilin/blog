{"expireTime":9007200818315814000,"key":"transformer-remark-markdown-html-ast-0edbe4f9ccb0b393f769b5a045bc398e-gatsby-remark-katexgatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"It is well-known that Node.js is an event based JavaScript  runtime environment. And today let's dig deeper into the source code and have a look at how this event mechanism is implemented.","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":189,"offset":189}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":189,"offset":189}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> EventEmitter <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'events'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">MyEmitter</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">EventEmitter</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> myEmitter <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">MyEmitter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmyEmitter<span class=\"token punctuation\">.</span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token string\">'event'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'an event occurred!'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nmyEmitter<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'event'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":4,"column":1,"offset":191},"end":{"line":14,"column":4,"offset":421}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Here is demo of the core function of the events. Therefore it is reasonable that we just focus on functions shown in this demo.","position":{"start":{"line":16,"column":1,"offset":423},"end":{"line":16,"column":128,"offset":550}}}],"position":{"start":{"line":16,"column":1,"offset":423},"end":{"line":16,"column":128,"offset":550}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The event relevant code lies in the ","position":{"start":{"line":18,"column":1,"offset":552},"end":{"line":18,"column":37,"offset":588}}},{"type":"raw","value":"<code class=\"language-text\">./lib/events.js</code>","position":{"start":{"line":18,"column":37,"offset":588},"end":{"line":18,"column":54,"offset":605}}},{"type":"text","value":" file. Apparently, the code exports ","position":{"start":{"line":18,"column":54,"offset":605},"end":{"line":18,"column":90,"offset":641}}},{"type":"raw","value":"<code class=\"language-text\">EventEmitter</code>","position":{"start":{"line":18,"column":90,"offset":641},"end":{"line":18,"column":105,"offset":656}}},{"type":"text","value":" function as its default export.","position":{"start":{"line":18,"column":105,"offset":656},"end":{"line":18,"column":137,"offset":688}}}],"position":{"start":{"line":18,"column":1,"offset":552},"end":{"line":18,"column":137,"offset":688}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">EventEmitter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  EventEmitter<span class=\"token punctuation\">.</span><span class=\"token function\">init</span><span class=\"token punctuation\">.</span><span class=\"token function\">call</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\nmodule<span class=\"token punctuation\">.</span>exports <span class=\"token operator\">=</span> EventEmitter<span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":20,"column":1,"offset":690},"end":{"line":25,"column":4,"offset":798}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And the initialization is also simple. It only give initial value to some properties, ","position":{"start":{"line":27,"column":1,"offset":800},"end":{"line":27,"column":87,"offset":886}}},{"type":"raw","value":"<code class=\"language-text\">this._event</code>","position":{"start":{"line":27,"column":87,"offset":886},"end":{"line":27,"column":100,"offset":899}}},{"type":"text","value":" is a null object   that could map the event name to the function and ","position":{"start":{"line":27,"column":100,"offset":899},"end":{"line":27,"column":170,"offset":969}}},{"type":"raw","value":"<code class=\"language-text\">this._eventsCount</code>","position":{"start":{"line":27,"column":170,"offset":969},"end":{"line":27,"column":189,"offset":988}}},{"type":"text","value":" is the total number of the events.","position":{"start":{"line":27,"column":189,"offset":988},"end":{"line":27,"column":224,"offset":1023}}}],"position":{"start":{"line":27,"column":1,"offset":800},"end":{"line":27,"column":224,"offset":1023}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">EventEmitter<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">init</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_events <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span> <span class=\"token operator\">||</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_events <span class=\"token operator\">===</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">getPrototypeOf</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>_events<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_events <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_eventsCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_maxListeners <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_maxListeners <span class=\"token operator\">||</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":29,"column":1,"offset":1025},"end":{"line":39,"column":4,"offset":1304}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"Now comes the untrivial parts.","position":{"start":{"line":41,"column":1,"offset":1306},"end":{"line":41,"column":31,"offset":1336}}}],"position":{"start":{"line":41,"column":1,"offset":1306},"end":{"line":41,"column":31,"offset":1336}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The ","position":{"start":{"line":43,"column":1,"offset":1338},"end":{"line":43,"column":5,"offset":1342}}},{"type":"raw","value":"<code class=\"language-text\">on</code>","position":{"start":{"line":43,"column":5,"offset":1342},"end":{"line":43,"column":9,"offset":1346}}},{"type":"text","value":" function is a wrapper of the ","position":{"start":{"line":43,"column":9,"offset":1346},"end":{"line":43,"column":39,"offset":1376}}},{"type":"raw","value":"<code class=\"language-text\">addListener</code>","position":{"start":{"line":43,"column":39,"offset":1376},"end":{"line":43,"column":52,"offset":1389}}},{"type":"text","value":", which is a wrapper of ","position":{"start":{"line":43,"column":52,"offset":1389},"end":{"line":43,"column":76,"offset":1413}}},{"type":"raw","value":"<code class=\"language-text\">_addListener</code>","position":{"start":{"line":43,"column":76,"offset":1413},"end":{"line":43,"column":90,"offset":1427}}},{"type":"text","value":":","position":{"start":{"line":43,"column":90,"offset":1427},"end":{"line":43,"column":91,"offset":1428}}}],"position":{"start":{"line":43,"column":1,"offset":1338},"end":{"line":43,"column":91,"offset":1428}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">addListener</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">addListener</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> listener</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">_addListener</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">,</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>on <span class=\"token operator\">=</span> <span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>addListener<span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":45,"column":1,"offset":1430},"end":{"line":51,"column":4,"offset":1643}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So our main focus would be the ","position":{"start":{"line":53,"column":1,"offset":1645},"end":{"line":53,"column":32,"offset":1676}}},{"type":"raw","value":"<code class=\"language-text\">_addListener</code>","position":{"start":{"line":53,"column":32,"offset":1676},"end":{"line":53,"column":46,"offset":1690}}},{"type":"text","value":" function, notice the ","position":{"start":{"line":53,"column":46,"offset":1690},"end":{"line":53,"column":68,"offset":1712}}},{"type":"raw","value":"<code class=\"language-text\">target</code>","position":{"start":{"line":53,"column":68,"offset":1712},"end":{"line":53,"column":76,"offset":1720}}},{"type":"text","value":" argument is the ","position":{"start":{"line":53,"column":76,"offset":1720},"end":{"line":53,"column":93,"offset":1737}}},{"type":"raw","value":"<code class=\"language-text\">EventEmitter</code>","position":{"start":{"line":53,"column":93,"offset":1737},"end":{"line":53,"column":107,"offset":1751}}},{"type":"text","value":" object.","position":{"start":{"line":53,"column":107,"offset":1751},"end":{"line":53,"column":115,"offset":1759}}}],"position":{"start":{"line":53,"column":1,"offset":1645},"end":{"line":53,"column":115,"offset":1759}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">_addListener</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">target<span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">,</span> prepend</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> m<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> events<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> existing<span class=\"token punctuation\">;</span>\n  \n  <span class=\"token comment\">// To check if listener is function.</span>\n  <span class=\"token function\">checkListener</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  events <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>_events<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>events <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    events <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>_events <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    target<span class=\"token punctuation\">.</span>_eventsCount <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// To avoid recursion in the case that type === \"newListener\"! Before</span>\n    <span class=\"token comment\">// adding it to the listeners, first emit \"newListener\".</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>events<span class=\"token punctuation\">.</span>newListener <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      target<span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token string\">'newListener'</span><span class=\"token punctuation\">,</span> type<span class=\"token punctuation\">,</span>\n                  listener<span class=\"token punctuation\">.</span>listener <span class=\"token operator\">?</span> listener<span class=\"token punctuation\">.</span>listener <span class=\"token punctuation\">:</span> listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      <span class=\"token comment\">// Re-assign `events` because a newListener handler could have caused the</span>\n      <span class=\"token comment\">// this._events to be assigned to a new object</span>\n      events <span class=\"token operator\">=</span> target<span class=\"token punctuation\">.</span>_events<span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n    existing <span class=\"token operator\">=</span> events<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>existing <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Optimize the case of one listener. Don't need the extra array object.</span>\n    events<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> listener<span class=\"token punctuation\">;</span>\n    <span class=\"token operator\">++</span>target<span class=\"token punctuation\">.</span>_eventsCount<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> existing <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Adding the second element, need to change to array.</span>\n      existing <span class=\"token operator\">=</span> events<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span>\n        prepend <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span>listener<span class=\"token punctuation\">,</span> existing<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">:</span> <span class=\"token punctuation\">[</span>existing<span class=\"token punctuation\">,</span> listener<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// If we've already got an array, just append.</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prepend<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      existing<span class=\"token punctuation\">.</span><span class=\"token function\">unshift</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      existing<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>listener<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Check for listener leak</span>\n    m <span class=\"token operator\">=</span> <span class=\"token function\">$getMaxListeners</span><span class=\"token punctuation\">(</span>target<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>m <span class=\"token operator\">></span> <span class=\"token number\">0</span> <span class=\"token operator\">&amp;&amp;</span> existing<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> m <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>existing<span class=\"token punctuation\">.</span>warned<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      existing<span class=\"token punctuation\">.</span>warned <span class=\"token operator\">=</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n      <span class=\"token comment\">// No error code for this since it is a Warning</span>\n      <span class=\"token comment\">// eslint-disable-next-line no-restricted-syntax</span>\n      <span class=\"token keyword\">const</span> w <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Possible EventEmitter memory leak detected. '</span> <span class=\"token operator\">+</span>\n                          <span class=\"token template-string\"><span class=\"token string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>existing<span class=\"token punctuation\">.</span>length<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token function\">String</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> listeners `</span></span> <span class=\"token operator\">+</span>\n                          <span class=\"token string\">'added. Use emitter.setMaxListeners() to '</span> <span class=\"token operator\">+</span>\n                          <span class=\"token string\">'increase limit'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      w<span class=\"token punctuation\">.</span>name <span class=\"token operator\">=</span> <span class=\"token string\">'MaxListenersExceededWarning'</span><span class=\"token punctuation\">;</span>\n      w<span class=\"token punctuation\">.</span>emitter <span class=\"token operator\">=</span> target<span class=\"token punctuation\">;</span>\n      w<span class=\"token punctuation\">.</span>type <span class=\"token operator\">=</span> type<span class=\"token punctuation\">;</span>\n      w<span class=\"token punctuation\">.</span>count <span class=\"token operator\">=</span> existing<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n      process<span class=\"token punctuation\">.</span><span class=\"token function\">emitWarning</span><span class=\"token punctuation\">(</span>w<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> target<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":55,"column":1,"offset":1761},"end":{"line":118,"column":4,"offset":3839}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"The comment in the code is really clear. The major part of the code is to add the ","position":{"start":{"line":120,"column":1,"offset":3841},"end":{"line":120,"column":83,"offset":3923}}},{"type":"raw","value":"<code class=\"language-text\">listener</code>","position":{"start":{"line":120,"column":83,"offset":3923},"end":{"line":120,"column":93,"offset":3933}}},{"type":"text","value":" to  ","position":{"start":{"line":120,"column":93,"offset":3933},"end":{"line":120,"column":98,"offset":3938}}},{"type":"raw","value":"<code class=\"language-text\">_events</code>","position":{"start":{"line":120,"column":98,"offset":3938},"end":{"line":120,"column":107,"offset":3947}}},{"type":"text","value":" and add one to ","position":{"start":{"line":120,"column":107,"offset":3947},"end":{"line":120,"column":123,"offset":3963}}},{"type":"raw","value":"<code class=\"language-text\">_eventsCount</code>","position":{"start":{"line":120,"column":123,"offset":3963},"end":{"line":120,"column":137,"offset":3977}}},{"type":"text","value":". Also, if there is an existing listener, we will substitute it. Notice, if there is a ","position":{"start":{"line":120,"column":137,"offset":3977},"end":{"line":120,"column":224,"offset":4064}}},{"type":"raw","value":"<code class=\"language-text\">&quot;newListener&quot;</code>","position":{"start":{"line":120,"column":224,"offset":4064},"end":{"line":120,"column":239,"offset":4079}}},{"type":"text","value":" listener registered, it will be called before add the ","position":{"start":{"line":120,"column":239,"offset":4079},"end":{"line":120,"column":294,"offset":4134}}},{"type":"raw","value":"<code class=\"language-text\">listener</code>","position":{"start":{"line":120,"column":294,"offset":4134},"end":{"line":120,"column":304,"offset":4144}}},{"type":"text","value":" to  ","position":{"start":{"line":120,"column":304,"offset":4144},"end":{"line":120,"column":309,"offset":4149}}},{"type":"raw","value":"<code class=\"language-text\">_events</code>","position":{"start":{"line":120,"column":309,"offset":4149},"end":{"line":120,"column":318,"offset":4158}}},{"type":"text","value":".","position":{"start":{"line":120,"column":318,"offset":4158},"end":{"line":120,"column":319,"offset":4159}}}],"position":{"start":{"line":120,"column":1,"offset":3841},"end":{"line":120,"column":319,"offset":4159}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"And for emit: ","position":{"start":{"line":122,"column":1,"offset":4161},"end":{"line":122,"column":15,"offset":4175}}}],"position":{"start":{"line":122,"column":1,"offset":4161},"end":{"line":122,"column":15,"offset":4175}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span><span class=\"token function-variable function\">emit</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span> <span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> doError <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'error'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">// if we are emitting an error</span>\n\n  <span class=\"token keyword\">const</span> events <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_events<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>events <span class=\"token operator\">!==</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span>\n    doError <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>doError <span class=\"token operator\">&amp;&amp;</span> events<span class=\"token punctuation\">.</span>error <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>doError<span class=\"token punctuation\">)</span>  <span class=\"token comment\">// event is undefined but emit event other than error.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">// If there is no 'error' event listener then throw.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>doError<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">let</span> er<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      er <span class=\"token operator\">=</span> args<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>er <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> kExpandStackSymbol <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'internal/util'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> capture <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        Error<span class=\"token punctuation\">.</span><span class=\"token function\">captureStackTrace</span><span class=\"token punctuation\">(</span>capture<span class=\"token punctuation\">,</span> <span class=\"token class-name\">EventEmitter</span><span class=\"token punctuation\">.</span>prototype<span class=\"token punctuation\">.</span>emit<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        Object<span class=\"token punctuation\">.</span><span class=\"token function\">defineProperty</span><span class=\"token punctuation\">(</span>er<span class=\"token punctuation\">,</span> kExpandStackSymbol<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n          value<span class=\"token punctuation\">:</span> <span class=\"token function\">enhanceStackTrace</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> er<span class=\"token punctuation\">,</span> capture<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          configurable<span class=\"token punctuation\">:</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n\n      <span class=\"token comment\">// Note: The comments on the `throw` lines are intentional, they show</span>\n      <span class=\"token comment\">// up in Node's output if this results in an unhandled exception.</span>\n      <span class=\"token keyword\">throw</span> er<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Unhandled 'error' event</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token comment\">// At least give some kind of context to the user</span>\n    <span class=\"token keyword\">const</span> errors <span class=\"token operator\">=</span> <span class=\"token function\">lazyErrors</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> err <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">errors<span class=\"token punctuation\">.</span>ERR_UNHANDLED_ERROR</span><span class=\"token punctuation\">(</span>er<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    err<span class=\"token punctuation\">.</span>context <span class=\"token operator\">=</span> er<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">throw</span> err<span class=\"token punctuation\">;</span> <span class=\"token comment\">// Unhandled 'error' event</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> handler <span class=\"token operator\">=</span> events<span class=\"token punctuation\">[</span>type<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>handler <span class=\"token operator\">===</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> handler <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">Reflect</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> len <span class=\"token operator\">=</span> handler<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> listeners <span class=\"token operator\">=</span> <span class=\"token function\">arrayClone</span><span class=\"token punctuation\">(</span>handler<span class=\"token punctuation\">,</span> len<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">var</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> len<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span>\n      <span class=\"token function\">Reflect</span><span class=\"token punctuation\">.</span><span class=\"token function\">apply</span><span class=\"token punctuation\">(</span>listeners<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":124,"column":1,"offset":4177},"end":{"line":177,"column":4,"offset":5805}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"In the ","position":{"start":{"line":179,"column":1,"offset":5807},"end":{"line":179,"column":8,"offset":5814}}},{"type":"raw","value":"<code class=\"language-text\">emit</code>","position":{"start":{"line":179,"column":8,"offset":5814},"end":{"line":179,"column":14,"offset":5820}}},{"type":"text","value":" function, we will call the handler in the ","position":{"start":{"line":179,"column":14,"offset":5820},"end":{"line":179,"column":57,"offset":5863}}},{"type":"raw","value":"<code class=\"language-text\">_events</code>","position":{"start":{"line":179,"column":57,"offset":5863},"end":{"line":179,"column":66,"offset":5872}}},{"type":"text","value":", except for ","position":{"start":{"line":179,"column":66,"offset":5872},"end":{"line":179,"column":79,"offset":5885}}},{"type":"raw","value":"<code class=\"language-text\">&quot;error&quot;</code>","position":{"start":{"line":179,"column":79,"offset":5885},"end":{"line":179,"column":88,"offset":5894}}},{"type":"text","value":", which will be used as error processing.","position":{"start":{"line":179,"column":88,"offset":5894},"end":{"line":179,"column":129,"offset":5935}}}],"position":{"start":{"line":179,"column":1,"offset":5807},"end":{"line":179,"column":129,"offset":5935}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"So basically, the events module is just save the event handlers in the EventEmitter and call it when emitting.","position":{"start":{"line":181,"column":1,"offset":5937},"end":{"line":181,"column":111,"offset":6047}}}],"position":{"start":{"line":181,"column":1,"offset":5937},"end":{"line":181,"column":111,"offset":6047}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":183,"column":1,"offset":6049}}}}