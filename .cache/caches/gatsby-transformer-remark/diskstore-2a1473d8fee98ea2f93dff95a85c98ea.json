{"expireTime":9007200818315813000,"key":"transformer-remark-markdown-html-ast-890a08e8e7ba7c9de81bc1f84170b83d-gatsby-remark-katexgatsby-remark-prismjs-","val":{"type":"root","children":[{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"本次作业会处理一个简单的用户的thread包，用于实现context switching.","position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":46,"offset":46}}}],"position":{"start":{"line":2,"column":1,"offset":1},"end":{"line":2,"column":46,"offset":46}}},{"type":"text","value":"\n"},{"type":"element","tagName":"h2","properties":{},"children":[{"type":"text","value":"Switching threads","position":{"start":{"line":4,"column":4,"offset":51},"end":{"line":4,"column":21,"offset":68}}}],"position":{"start":{"line":4,"column":1,"offset":48},"end":{"line":4,"column":21,"offset":68}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"下载","position":{"start":{"line":6,"column":1,"offset":70},"end":{"line":6,"column":3,"offset":72}}},{"type":"raw","value":"<code class=\"language-text\">uthread.c</code>","position":{"start":{"line":6,"column":3,"offset":72},"end":{"line":6,"column":14,"offset":83}}},{"type":"text","value":"和","position":{"start":{"line":6,"column":14,"offset":83},"end":{"line":6,"column":15,"offset":84}}},{"type":"raw","value":"<code class=\"language-text\">uthread_switch.S</code>","position":{"start":{"line":6,"column":15,"offset":84},"end":{"line":6,"column":33,"offset":102}}},{"type":"text","value":"，然后修改xv6的","position":{"start":{"line":6,"column":33,"offset":102},"end":{"line":6,"column":42,"offset":111}}},{"type":"raw","value":"<code class=\"language-text\">Makefile</code>","position":{"start":{"line":6,"column":42,"offset":111},"end":{"line":6,"column":52,"offset":121}}}],"position":{"start":{"line":6,"column":1,"offset":70},"end":{"line":6,"column":52,"offset":121}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"需要写的代码在","position":{"start":{"line":8,"column":1,"offset":123},"end":{"line":8,"column":8,"offset":130}}},{"type":"raw","value":"<code class=\"language-text\">uthread_switch.S</code>","position":{"start":{"line":8,"column":8,"offset":130},"end":{"line":8,"column":26,"offset":148}}},{"type":"text","value":"里。","position":{"start":{"line":8,"column":26,"offset":148},"end":{"line":8,"column":28,"offset":150}}}],"position":{"start":{"line":8,"column":1,"offset":123},"end":{"line":8,"column":28,"offset":150}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"assembly\"><pre class=\"language-assembly\"><code class=\"language-assembly\">\t.text\n\n/* Switch from current_thread to next_thread. Make next_thread\n * the current_thread, and set next_thread to 0.\n * Use eax as a temporary register; it is caller saved.\n */\n\t.globl thread_switch\nthread_switch:\n\t/* YOUR CODE HERE */\n\t# right now, the stack pointer points at stack of current_thread\n\tpushal  # save all registers\n\t# switch to next_thread\n\tmovl next_thread, %eax\n\tmovl %eax, current_thread\n\tmovl $0, next_thread\n\tmovl (%eax), %esp  # load stack address of next_thread\n\tpopal\n\tret\t\t\t\t/* pop return address from stack */</code></pre></div>","position":{"start":{"line":10,"column":1,"offset":152},"end":{"line":29,"column":4,"offset":707}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"注意这里面的使用了","position":{"start":{"line":31,"column":1,"offset":709},"end":{"line":31,"column":10,"offset":718}}},{"type":"raw","value":"<code class=\"language-text\">uthread.c</code>","position":{"start":{"line":31,"column":10,"offset":718},"end":{"line":31,"column":21,"offset":729}}},{"type":"text","value":"中的结构：","position":{"start":{"line":31,"column":21,"offset":729},"end":{"line":31,"column":26,"offset":734}}}],"position":{"start":{"line":31,"column":1,"offset":709},"end":{"line":31,"column":26,"offset":734}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">struct</span> <span class=\"token class-name\">thread</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span>        sp<span class=\"token punctuation\">;</span>                <span class=\"token comment\">/* saved stack pointer */</span>\n  <span class=\"token keyword\">char</span> stack<span class=\"token punctuation\">[</span>STACK_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">/* the thread's stack */</span>\n  <span class=\"token keyword\">int</span>        state<span class=\"token punctuation\">;</span>             <span class=\"token comment\">/* FREE, RUNNING, RUNNABLE */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></code></pre></div>","position":{"start":{"line":33,"column":1,"offset":736},"end":{"line":39,"column":4,"offset":940}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"raw","value":"<code class=\"language-text\">next_thread</code>","position":{"start":{"line":41,"column":1,"offset":942},"end":{"line":41,"column":14,"offset":955}}},{"type":"text","value":"和","position":{"start":{"line":41,"column":14,"offset":955},"end":{"line":41,"column":15,"offset":956}}},{"type":"raw","value":"<code class=\"language-text\">current_thread</code>","position":{"start":{"line":41,"column":15,"offset":956},"end":{"line":41,"column":31,"offset":972}}},{"type":"text","value":"都是","position":{"start":{"line":41,"column":31,"offset":972},"end":{"line":41,"column":33,"offset":974}}},{"type":"raw","value":"<code class=\"language-text\">struct thread *</code>","position":{"start":{"line":41,"column":33,"offset":974},"end":{"line":41,"column":50,"offset":991}}},{"type":"text","value":"。然后一个stack的结构在","position":{"start":{"line":41,"column":50,"offset":991},"end":{"line":41,"column":64,"offset":1005}}},{"type":"raw","value":"<code class=\"language-text\">thread_create()</code>","position":{"start":{"line":41,"column":64,"offset":1005},"end":{"line":41,"column":81,"offset":1022}}},{"type":"text","value":"函数中体现了：","position":{"start":{"line":41,"column":81,"offset":1022},"end":{"line":41,"column":88,"offset":1029}}}],"position":{"start":{"line":41,"column":1,"offset":942},"end":{"line":41,"column":88,"offset":1029}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token keyword\">void</span> \n<span class=\"token function\">thread_create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  thread_p t<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> all_thread<span class=\"token punctuation\">;</span> t <span class=\"token operator\">&lt;</span> all_thread <span class=\"token operator\">+</span> MAX_THREAD<span class=\"token punctuation\">;</span> t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>state <span class=\"token operator\">==</span> FREE<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  t<span class=\"token operator\">-></span>sp <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>stack <span class=\"token operator\">+</span> STACK_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// set sp to the top of the stack</span>\n  t<span class=\"token operator\">-></span>sp <span class=\"token operator\">-=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>                              <span class=\"token comment\">// space for return address</span>\n  <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>sp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>func<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// push return address on stack</span>\n  t<span class=\"token operator\">-></span>sp <span class=\"token operator\">-=</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>                             <span class=\"token comment\">// space for registers that thread_switch expects</span>\n  t<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> RUNNABLE<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":43,"column":1,"offset":1031},"end":{"line":58,"column":4,"offset":1529}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"也就是最上面是32byte用于","position":{"start":{"line":60,"column":1,"offset":1531},"end":{"line":60,"column":16,"offset":1546}}},{"type":"raw","value":"<code class=\"language-text\">pushal</code>","position":{"start":{"line":60,"column":16,"offset":1546},"end":{"line":60,"column":24,"offset":1554}}},{"type":"text","value":"和","position":{"start":{"line":60,"column":24,"offset":1554},"end":{"line":60,"column":25,"offset":1555}}},{"type":"raw","value":"<code class=\"language-text\">popal</code>","position":{"start":{"line":60,"column":25,"offset":1555},"end":{"line":60,"column":32,"offset":1562}}},{"type":"text","value":"，再上面就是线程对应的函数。","position":{"start":{"line":60,"column":32,"offset":1562},"end":{"line":60,"column":46,"offset":1576}}}],"position":{"start":{"line":60,"column":1,"offset":1531},"end":{"line":60,"column":46,"offset":1576}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"然后就运行就好了，注意运行的时候要加上","position":{"start":{"line":62,"column":1,"offset":1578},"end":{"line":62,"column":20,"offset":1597}}},{"type":"raw","value":"<code class=\"language-text\">CPUS=1</code>","position":{"start":{"line":62,"column":20,"offset":1597},"end":{"line":62,"column":28,"offset":1605}}}],"position":{"start":{"line":62,"column":1,"offset":1578},"end":{"line":62,"column":28,"offset":1605}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">$ <span class=\"token function\">make</span> CPUS<span class=\"token operator\">=</span>1 qemu-nox\nqemu-system-i386 -nographic -drive file<span class=\"token operator\">=</span>fs.img,index<span class=\"token operator\">=</span>1,media<span class=\"token operator\">=</span>disk,format<span class=\"token operator\">=</span>raw -drive file<span class=\"token operator\">=</span>xv6.img,index<span class=\"token operator\">=</span>0,media<span class=\"token operator\">=</span>disk,format<span class=\"token operator\">=</span>raw -smp 1 -m 512\nxv6<span class=\"token punctuation\">..</span>.\ncpu0: starting 0\nsb: size 1000 nblocks 941 ninodes 200 nlog 30 logstart 2 inodestart 32 bmap start 58\ninit: starting sh\n$ uthread\nmy thread running\nmy thread 0x2DC8\nmy thread running\nmy thread 0x4DD0\nmy thread running\n<span class=\"token punctuation\">..</span>.</code></pre></div>","position":{"start":{"line":64,"column":1,"offset":1607},"end":{"line":78,"column":4,"offset":2011}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"这次的作业相当于补全了一个用户的thread库。这个库都体现在了","position":{"start":{"line":80,"column":1,"offset":2013},"end":{"line":80,"column":33,"offset":2045}}},{"type":"raw","value":"<code class=\"language-text\">uthread.c</code>","position":{"start":{"line":80,"column":33,"offset":2045},"end":{"line":80,"column":44,"offset":2056}}},{"type":"text","value":"中，为了之后查找方便，列在下面：","position":{"start":{"line":80,"column":44,"offset":2056},"end":{"line":80,"column":60,"offset":2072}}}],"position":{"start":{"line":80,"column":1,"offset":2013},"end":{"line":80,"column":60,"offset":2072}}},{"type":"text","value":"\n"},{"type":"raw","value":"<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">\"types.h\"</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">\"stat.h\"</span></span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">include</span> <span class=\"token string\">\"user.h\"</span></span>\n\n<span class=\"token comment\">/* Possible states of a thread; */</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> FREE        0x0</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> RUNNING     0x1</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> RUNNABLE    0x2</span>\n\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> STACK_SIZE  8192</span>\n<span class=\"token macro property\">#<span class=\"token directive keyword\">define</span> MAX_THREAD  4</span>\n\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">thread</span> thread_t<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>thread_p<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">typedef</span> <span class=\"token keyword\">struct</span> <span class=\"token class-name\">mutex</span> mutex_t<span class=\"token punctuation\">,</span> <span class=\"token operator\">*</span>mutex_p<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">thread</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span>        sp<span class=\"token punctuation\">;</span>                <span class=\"token comment\">/* saved stack pointer */</span>\n  <span class=\"token keyword\">char</span> stack<span class=\"token punctuation\">[</span>STACK_SIZE<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>       <span class=\"token comment\">/* the thread's stack */</span>\n  <span class=\"token keyword\">int</span>        state<span class=\"token punctuation\">;</span>             <span class=\"token comment\">/* FREE, RUNNING, RUNNABLE */</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">static</span> thread_t all_thread<span class=\"token punctuation\">[</span>MAX_THREAD<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nthread_p  current_thread<span class=\"token punctuation\">;</span>\nthread_p  next_thread<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">extern</span> <span class=\"token keyword\">void</span> <span class=\"token function\">thread_switch</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">void</span> \n<span class=\"token function\">thread_init</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// main() is thread 0, which will make the first invocation to</span>\n  <span class=\"token comment\">// thread_schedule().  it needs a stack so that the first thread_switch() can</span>\n  <span class=\"token comment\">// save thread 0's state.  thread_schedule() won't run the main thread ever</span>\n  <span class=\"token comment\">// again, because its state is set to RUNNING, and thread_schedule() selects</span>\n  <span class=\"token comment\">// a RUNNABLE thread.</span>\n  current_thread <span class=\"token operator\">=</span> <span class=\"token operator\">&amp;</span>all_thread<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  current_thread<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> RUNNING<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> \n<span class=\"token function\">thread_schedule</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  thread_p t<span class=\"token punctuation\">;</span>\n\n  <span class=\"token comment\">/* Find another runnable thread. */</span>\n  next_thread <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> all_thread<span class=\"token punctuation\">;</span> t <span class=\"token operator\">&lt;</span> all_thread <span class=\"token operator\">+</span> MAX_THREAD<span class=\"token punctuation\">;</span> t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>state <span class=\"token operator\">==</span> RUNNABLE <span class=\"token operator\">&amp;&amp;</span> t <span class=\"token operator\">!=</span> current_thread<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      next_thread <span class=\"token operator\">=</span> t<span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">>=</span> all_thread <span class=\"token operator\">+</span> MAX_THREAD <span class=\"token operator\">&amp;&amp;</span> current_thread<span class=\"token operator\">-></span>state <span class=\"token operator\">==</span> RUNNABLE<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">/* The current thread is the only runnable thread; run it. */</span>\n    next_thread <span class=\"token operator\">=</span> current_thread<span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>next_thread <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"thread_schedule: no runnable threads\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">exit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>current_thread <span class=\"token operator\">!=</span> next_thread<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>         <span class=\"token comment\">/* switch threads?  */</span>\n    next_thread<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> RUNNING<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">thread_switch</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span>\n    next_thread <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> \n<span class=\"token function\">thread_create</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">*</span>func<span class=\"token punctuation\">)</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  thread_p t<span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>t <span class=\"token operator\">=</span> all_thread<span class=\"token punctuation\">;</span> t <span class=\"token operator\">&lt;</span> all_thread <span class=\"token operator\">+</span> MAX_THREAD<span class=\"token punctuation\">;</span> t<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>state <span class=\"token operator\">==</span> FREE<span class=\"token punctuation\">)</span> <span class=\"token keyword\">break</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  t<span class=\"token operator\">-></span>sp <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>stack <span class=\"token operator\">+</span> STACK_SIZE<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>   <span class=\"token comment\">// set sp to the top of the stack</span>\n  t<span class=\"token operator\">-></span>sp <span class=\"token operator\">-=</span> <span class=\"token number\">4</span><span class=\"token punctuation\">;</span>                              <span class=\"token comment\">// space for return address</span>\n  <span class=\"token operator\">*</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> <span class=\"token operator\">*</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">(</span>t<span class=\"token operator\">-></span>sp<span class=\"token punctuation\">)</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span>func<span class=\"token punctuation\">;</span>           <span class=\"token comment\">// push return address on stack</span>\n  t<span class=\"token operator\">-></span>sp <span class=\"token operator\">-=</span> <span class=\"token number\">32</span><span class=\"token punctuation\">;</span>                             <span class=\"token comment\">// space for registers that thread_switch expects</span>\n  t<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> RUNNABLE<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">void</span> \n<span class=\"token function\">thread_yield</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  current_thread<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> RUNNABLE<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">thread_schedule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">static</span> <span class=\"token keyword\">void</span> \n<span class=\"token function\">mythread</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">void</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">int</span> i<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"my thread running\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span>i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> <span class=\"token number\">100</span><span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"my thread 0x%x\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span><span class=\"token punctuation\">)</span> current_thread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">thread_yield</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"my thread: exit\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  current_thread<span class=\"token operator\">-></span>state <span class=\"token operator\">=</span> FREE<span class=\"token punctuation\">;</span>\n  <span class=\"token function\">thread_schedule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n\n<span class=\"token keyword\">int</span> \n<span class=\"token function\">main</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">int</span> argc<span class=\"token punctuation\">,</span> <span class=\"token keyword\">char</span> <span class=\"token operator\">*</span>argv<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> \n<span class=\"token punctuation\">{</span>\n  <span class=\"token function\">thread_init</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">thread_create</span><span class=\"token punctuation\">(</span>mythread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">thread_create</span><span class=\"token punctuation\">(</span>mythread<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">thread_schedule</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>","position":{"start":{"line":82,"column":1,"offset":2074},"end":{"line":198,"column":4,"offset":4829}}},{"type":"text","value":"\n"},{"type":"element","tagName":"p","properties":{},"children":[{"type":"text","value":"相当于是thread主动进行yield来进行切换。","position":{"start":{"line":200,"column":1,"offset":4831},"end":{"line":200,"column":26,"offset":4856}}}],"position":{"start":{"line":200,"column":1,"offset":4831},"end":{"line":200,"column":26,"offset":4856}}}],"position":{"start":{"line":1,"column":1,"offset":0},"end":{"line":200,"column":26,"offset":4856}}}}